set ThisScriptDir [file dirname [info script]]
set LibDir [file join $ThisScriptDir .. lib]
set VendorDir [file join $ThisScriptDir .. vendor]
set FixturesDir [file join $ThisScriptDir fixtures]
source [file join $VendorDir xproc-0.1.tm]
source [file join $LibDir asm.tcl]
source [file join $ThisScriptDir test_helpers.tcl]


xproc::test assemble {{ns t} {
  # TODO: Add test for label that doesn't exist
  # TODO: Add test for $var not being substituted
  # TODO: Add tests for listing
  set cases [list \
    [dict create \
      filename [file join $::FixturesDir "helloworld.asq"] \
      result [list 16 -1 3 15 0 6 15 10 9 30 16 -1 30 30 0 -1 \
                   72 69 76 76 79 44 32 87 79 82 76 68 33 10 0]] \
    [dict create \
      filename [file join $::FixturesDir "adder.asq"] \
      result [list 15 18 3 16 18 6 17 18 9 18 -1 12 18 18 -1 -1 -2 -3 48 ]] \
    [dict create \
      filename [file join $::FixturesDir "adder_constants_maths.asq"] \
      result [list 15 18 3 16 18 6 17 18 9 18 -1 12 18 18 -1 -1 -2 -3 48 ]] \
    [dict create \
      filename [file join $::FixturesDir "call_ret_macros.asq"] \
      result [list 13 13 14 0 12 12 7 3 12 10 13 13 0 0 3 3 17 23 3 20 \
                   13 13 4 24 13 13 -1]] \
    [dict create \
      filename [file join $::FixturesDir "label_order.asq"] \
      result [list 12 12 6 12 12 0 12 12 -1 12 12 0 0]]

  ]
  foreach case $cases {
    dict with case {
      set src [TestHelpers::readFile $filename]
      lassign [${ns}::assemble $src] gotResult
      if {$gotResult != $result} {
        xproc::fail $t "got result: $gotResult, want: $result"
      }
    }
  }
}}
